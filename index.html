<!DOCTYPE html>
<html lang="en">
<head>
<meta content="text/html; charset=UTF-8" http-equiv="content-type" />
</head>

<body>
 <link rel="stylesheet" href="leaflet/leaflet.css">
<!-- Make sure you put this AFTER Leaflet's CSS -->
 <script src="leaflet/leaflet.js"></script>


<div id="mapid" style="height: 600px;"></div>

<script>

async function getVisibleStations(map) {
    let bounds = map.getBounds();
    let nelat = bounds._northEast.lat;
    let nelng = bounds._northEast.lng;
    let swlat = bounds._southWest.lat;
    let swlng = bounds._southWest.lng;
    // get the visible stations
    let params = "nelat=" + nelat + "&nelng=" + nelng + "&swlat=" + swlat + "&swlng=" + swlng;
    const response = await fetch('https://www.cester.net/railwayatlas/api/v1/stations/read.php?' + params);
    const json = await response.json();
    return json
}

function changeColorStrength(col, amt) {
    var usePound = false;
    if (col[0] == "#") { col = col.slice(1); usePound = true; }
    var num = parseInt(col,16);
    var r = (num >> 16) + amt;
    if ( r > 255 ) r = 255; else if  (r < 0) r = 0;
    var b = ((num >> 8) & 0x00FF) + amt;
    if ( b > 255 ) b = 255; else if  (b < 0) b = 0;
    var g = (num & 0x0000FF) + amt;
    if ( g > 255 ) g = 255; else if  ( g < 0 ) g = 0;
    return (usePound?"#":"") + (g | (b << 8) | (r << 16)).toString(16);
}

function adjustColor(color, amount) {
    return '#' + color.replace(/^#/, '').replace(/../g, color => ('0'+Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2));
}

function getStationMarkerOptions(station) {
    if (station.name.substring(0,6) == "Gaggio") {
        console.log(station);
        console.log('#0000aa', adjustColor('#0000aa', +80));
    }
    let size_fact = 2 - station.type;
    let color_bord = 'gray';
    let color_fill = 'white';
    // value1 = power : 0 = n/a, 1 = non el., 2 = 3kV, 3 = 15 kV, 4 = 25 kV
    switch (station.value1) { // power
        case '1': { color_bord = '#ff6600'; } break;
        case '2': { color_bord = '#0000aa'; } break;
        case '3': { color_bord = '#ff0000'; } break;
        case '4': { color_bord = '#339999'; } break;
        default: {  }
    }
    // value2 = status : 1 = normale, 2 = dismessa, 3 = lavori, 4 = no pax
     switch (station.value2) { // status
        case '2': { color_bord = adjustColor(color_bord, +120); } break;
        //case '3': { color_fill = '#ffff00'; } break;
        case '4': { color_fill = color_bord; } break;
        default: {  }
    }
    return {
      radius      : 5 + 3 * size_fact,
      fillColor   : color_fill,
      color       : color_bord,
      weight      : 2 + size_fact,
      opacity     : 1,
      fillOpacity : 1
    }
}

var markersVisible = {};
var markersToRemove = {};

async function updateMap(map) {
    visibleStations = await getVisibleStations(map);
    console.debug(visibleStations);
    markersToRemove = markersVisible;
    markersVisible = {}
    var added = 0;
    for (i = 0; i < visibleStations.length; i++) {
        let data = visibleStations[i];
        if (map.getZoom() >= data.min_zoom) {
            if (data.id in markersToRemove) {
                markersVisible[data.id] = markersToRemove[data.id];
                delete markersToRemove[data.id];
            } else {
                //station_icon = buildStationIcon(data);
                //let marker = L.marker([data.lat, data.lng], {icon: station_icon});
                let marker = L.circleMarker([data.lat, data.lng], getStationMarkerOptions(data));
                markersVisible[data.id] = marker;
                marker.addTo(map);
                added = added + 1;
            }
        }
    }
    for (const marker of Object.values(markersToRemove)) {
        map.removeLayer(marker);
    }
    // TODO: get the visible stretches, depending on the visible stations
}

var map = L.map('mapid').setView([45.6723, 12.2422], 8);
// add the OpenStreetMap tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 14,
        attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
}).addTo(map);
// show the scale bar on the lower left corner
L.control.scale().addTo(map);
// layer for visible markers
var markerLayers = 

// listeners
//map.on('zoomend', function(e){ updateMap(map); });
map.on("moveend", function(s){ updateMap(map); });
updateMap(map);

/*
for (i=0; i<lines.length; i++) {
    line = lines[i];
    console.debug("Plotting line " + line[0] + " - " + line[1] + "...");
    var point_a = new L.LatLng(stations[line[0]][0], stations[line[0]][1]);
    var point_b = new L.LatLng(stations[line[1]][0], stations[line[1]][1]);
    polyline = new L.Polyline([point_a, point_b], { color: line[2] });
    polyline.addTo(map);
};
*/



</script>



</body>
</html>
